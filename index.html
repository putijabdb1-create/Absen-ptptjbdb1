<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Pegawai - PT PUTRA TIMUR JAYA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #00141f, #003c5c, #00897b);
      background-size: 300% 300%;
      animation: gradientMove 16s ease infinite;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
    }

    @keyframes gradientMove {
      0%   { background-position: 0% 0%; }
      50%  { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }

    .wrapper {
      width: 100%;
      max-width: 460px;
    }

    .brand-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      color: #e0fdf2;
      text-shadow: 0 0 8px rgba(0,0,0,0.4);
    }

    .brand-logo {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      object-fit: cover;
      background: #e0fdf2;
      box-shadow: 0 0 16px rgba(0,255,200,0.65);
    }

    .brand-name {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 13px;
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(18px);
      width: 100%;
      border-radius: 22px;
      padding: 22px 18px 18px;
      box-shadow:
        0 25px 40px rgba(0, 0, 0, 0.35),
        0 0 20px rgba(0, 255, 200, 0.3);
      border: 1px solid rgba(255,255,255,0.55);
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    h2 {
      text-align: center;
      color: #0f172a;
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 16px;
    }

    label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #374151;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      margin-bottom: 10px;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus,
    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb33;
      background: #ffffff;
    }

    input[readonly] {
      background: #f3f4f6;
    }

    /* WARNA KETERANGAN */
    #ket {
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      color: #111827;
    }
    .status-masuk {
      background: #dcfce7 !important;
      border-color: #16a34a !important;
      color: #14532d !important;
    }
    .status-libur {
      background: #fee2e2 !important;
      border-color: #dc2626 !important;
      color: #7f1d1d !important;
    }
    .status-cuti {
      background: #dbeafe !important;
      border-color: #2563eb !important;
      color: #1e3a8a !important;
    }
    .status-sakit {
      background: #fef3c7 !important;
      border-color: #f59e0b !important;
      color: #92400e !important;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 10px;
      margin-top: -4px;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border-width: 1px;
      border-style: solid;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .b-masuk { background:#dcfce7; border-color:#16a34a; color:#14532d; }
    .b-libur { background:#fee2e2; border-color:#dc2626; color:#7f1d1d; }
    .b-cuti  { background:#dbeafe; border-color:#2563eb; color:#1e3a8a; }
    .b-sakit { background:#fef3c7; border-color:#f59e0b; color:#92400e; }

    video, canvas, img {
      width: 100%;
      border-radius: 12px;
    }

    video {
      background: #020617;
      max-height: 220px;
      object-fit: cover;
    }

    .btn {
      width: 100%;
      padding: 11px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
      letter-spacing: 0.01em;
    }

    .btn-camera { background:#020617; color:white; }
    .btn-masuk  { background:#2563eb; color:white; }
    .btn-pulang { background:#10b981; color:white; }
    .btn-login  { background:#0ea5e9; color:white; }
    .btn-logout { background:#ef4444; color:white; }

    .btn:hover { filter: brightness(1.05); }

    .small { font-size: 12px; color: #6b7280; }
    #statusMsg { margin-top: 8px; min-height: 16px; }

    #loginInfo {
      font-size: 12px;
      color: #065f46;
      font-weight: 600;
      margin-bottom: 6px;
    }

    hr {
      border: none;
      border-top: 1px dashed #e5e7eb;
      margin: 10px 0 14px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- HEADER BRAND -->
    <div class="brand-bar">
      <!-- file logo-pttj.png harus ada di folder yang sama -->
      <img src="logo-pttj.png" alt="Logo PT PUTRA TIMUR JAYA" class="brand-logo">
      <span class="brand-name">PT PUTRA TIMUR JAYA</span>
    </div>

    <div class="card">
      <h2>Absensi Pegawai</h2>

      <!-- ========= LOGIN SECTION ========= -->
      <div id="loginSection">
        <label>Login Teknisi</label>
        <input id="loginUser" placeholder="User ID">
        <input id="loginPass" type="password" placeholder="Password">
        <button class="btn btn-login" type="button" onclick="handleLogin()">üîë Login</button>
        <div class="small" style="margin-top:6px;">
          Hanya teknisi terdaftar yang dapat mengakses absensi.
        </div>
        <hr>
      </div>

      <!-- Info user login + tombol logout -->
      <div id="loginInfo" style="display:none;"></div>
      <button id="logoutBtn" class="btn btn-logout" type="button"
              style="display:none; margin-top:0;" onclick="handleLogout()">üö™ Logout</button>

      <!-- ========= ABSENSI SECTION (muncul setelah login) ========= -->
      <div id="absenSection" style="display:none; margin-top:10px;">

        <!-- 1. DIVISI -->
        <label>Divisi</label>
        <select id="divisiSelect" disabled>
          <option value="">-- Pilih Divisi --</option>
          <option value="IOAN">IOAN</option>
          <option value="PSB">PSB</option>
          <option value="PROJEK">PROJEK</option>
          <option value="PIC">PIC</option>
        </select>

        <!-- 2. NAMA (auto dari login) -->
        <label>Nama</label>
        <select id="namaSelect" disabled>
          <option value="">-- Pilih Pegawai --</option>
        </select>

        <!-- 3. NIK otomatis -->
        <label>NIK</label>
        <input id="nik" placeholder="NIK otomatis" readonly>

        <!-- 4. AREA KERJA -->
        <label>Area Kerja</label>
        <select id="area">
          <option value="">-- Pilih Area Kerja --</option>
          <option value="CMI">CMI</option>
          <option value="NJG">NJG</option>
          <option value="CLL">CLL</option>
          <option value="BTJ">BTJ</option>
          <option value="GNH">GNH</option>
          <option value="KNG">KNG</option>
        </select>

        <!-- 5. KETERANGAN -->
        <label>Keterangan</label>
        <select id="ket">
          <option value="masuk">Masuk</option>
          <option value="libur">Libur</option>
          <option value="cuti">Cuti</option>
          <option value="sakit">Sakit</option>
        </select>

        <div class="legend">
          <span class="badge b-masuk">Masuk = Hijau</span>
          <span class="badge b-libur">Libur = Merah</span>
          <span class="badge b-cuti">Cuti = Biru</span>
          <span class="badge b-sakit">Sakit = Kuning</span>
        </div>

        <label>Foto Absensi</label>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="preview" style="display:none; margin-top:5px;">

        <button class="btn btn-camera" type="button" onclick="ambilFoto()">üì∏ Ambil Foto</button>

        <label>Lokasi GPS</label>
        <div id="lokasi" class="small">Mengambil lokasi...</div>

        <button class="btn btn-masuk"  type="button" onclick="kirimAbsensi('masuk')">‚úÖ Absen Masuk</button>
        <button class="btn btn-pulang" type="button" onclick="kirimAbsensi('pulang')">üèÅ Absen Pulang</button>

        <div id="statusMsg" class="small"></div>
      </div>
    </div>
  </div>

<script>
  /********* LOGIN USER SIMPLE *********/
  // Format 1 baris user:
  // "username|password|nik|nama|divisi|defaultArea"
  const USER_LINES = [
	    	"PTJArip007|alvaro007|15889311|ARIP RAHMATULLOH|PIC|CMI",
		"PTJAgus25|Ajiz1989|16891202|AGUS|IOAN|NJG",
		"PTJAlfian07|Fianape7|16004674|ALFIAN PERMADI HERDIANSYAH|IOAN|CMI",
		"PTJAnggi13|Zhafran02|15892036|ANGGI SETIAWAN|IOAN|BTJ",
		"PTJAsep125|4sep5ule|15889318|ASEP SULAEMAN|IOAN|NJG",
		"PTJAsep006|Bacilu01|15889328|ASEP SUTARYAT|IOAN|BTJ",
		"PTJMardian67|Mardian67|16012066|DANDI MARDIANSYAH|IOAN|GNH",
		"PTJDeni017|Denok017|16050949|DENI EGI SAPUTRA|IOAN|CMI",
		"PTJDeni699|Deni@699|16850259|DENI WARDANI|IOAN|BTJ",
		"PTJDeniec15889321|Nanjung2025|15889321|DENIEC GORO SULISTYANTO|IOAN|NJG",
		"PTJDODIMARDANI004|Putija004|15889324|DODI MARDANI|IOAN|CLL",
		"PTJEngkos270|Kostaman80|15889334|ENGKOS KOSTAMAN|IOAN|NJG",
		"PTJFakhri95|Fakhr1995|15889339|FAKHRI RASYAD RAMDHANI|IOAN|CMI",
		"PTJGiant77|Telkom77|15889330|GIAN KRISTAL|IOAN|NJG",
		"PTJINDRA999|270310Aa|16921681|INDRA PRATAMA|IOAN|NJG",
		"PTJNugraha24|Street24|15882130|INSAN NUGRAHA|IOAN|CMI",
		"PTJIrfanm019|putija@1|16950710|IRFAN MAULANA|IOAN|CMI",
		"PTJIrfan16022301|Bacilu01|16022301|IRFAN NURJAMAN|IOAN|BTJ",
		"PTJJuli86|juli0786|15889309|JULI SURYANA|IOAN|NJG",
		"PTJNazli313|arkan2015|15889313|NAZLI RUDI YANTO|IOAN|CMI",
		"PTJRendyherwansyah|putija@2025|15902465|RENDI HERWANSYAH|IOAN|GNH",
		"PTJGaling28|galing2810|15901086|RIDWAN RISWANDI|IOAN|NJG",
		"PTJSahibul87|ahyad87|15889319|SAHIBUL AHYAD|IOAN|CMI",
		"PTJTaryana2004|atar2004|15889316|TARYANA|IOAN|CMI",
		"PTJTAUFIK046|PUTIJA046|15889345|TAUFIK HIDAYAT|IOAN|NJG",
		"PTJTisna05|241103rm|15889326|TISNA|IOAN|BTJ",
		"PTJUjang77|uchin2877|15889333|UJANG MUKSIN|IOAN|CMI",
		"PTJYogi28|Yogi2828|16950715|YOGI TJANDRA FERNANDO|IOAN|CMI",
		"PTJYUNUS696|Absen696|15900696|YUNUS HITOTUN|IOAN|CMI",
		"PTJBob1990|TE1990|BELUM ADA|ASEP SAEPUDIN|PIC|CMI",
		"PTJDu2ng|Aisha221011|BELUM ADA|DUDUNG SUKMANA|PIC|CMI",
		"PTJEndi1994|Ardila06@@|15889307|ENDI HENDRIANA|PIC|CMI",
		"PTJFirmanFirdaus013|FirmanFirdaus013|16990042|MUHAMMAD FIRMAN DAUD FIRDAUS|PIC|CMI",
		"PTJUSetiadi|30223023|15889310|UUS SETIADI|PIC|BTJ",
		"PTJVikri012|Vikri0012|BELUM ADA|VIKRI FADHI RAHMAN|PIC|BTJ",
		"PTJAditya129|aditya0707|BELUM ADA|ADITYA RAMDAN SYARIF|PSB|BTJ",
		"PTJYusup16942254|putija@2028|16942254|AHMAD MAULANA YUSUP|PSB|BTJ",
		"PTJAhmad29040|zaki290406|BELUM ADA|AHMAD ZAQI|PSB|CMI",
		"PTJAndi027|mspeed27|16952753|ANDI RAMDANI|PSB|CMI",
		"PTJANDIAN666|123Asik#|BELUM ADA|ANDIAN WAHYUDI|PSB|CLL",
		"PTJArdian17|deci12345|BELUM ADA|ARDIAN HAFIDZ|PSB|BTJ",
		"PTJArga003|Arga1603|16901188|ARGA ALI SANTIAJI|PSB|NJG",
		"PTJAria015|Aria2025|16911316|ARIA RIDWANTO|PSB|CLL",
		"PTJAsep0797|Telkom0797|16974185|ASEP SAEPUL HIDAYAT|PSB|GNH",
		"PTJDedi08|RizkiRizam12|16820493|DEDI WINARDI|PSB|NJG",
		"PTJEnjang93|Hardi1993|16931851|ENJANG HARDI|PSB|CMI",
		"PTJFebby90|putija25|16901210|FEBBY REZA NURHUDA|PSB|CLL",
		"PTJIbnuDcs|Kududiuye|16022542|IBNU DZAHABI|PSB|CMI",
		"PTJBowo182|makemanah85|16850029|KHOERUDIN PRABOWO|PSB|CMI",
		"PTJIlyas1289|Rilkay2018|15891521|KM ILYAS AKBAR|PSB|NJG",
		"PTJPadiiiL7|padilada22|BELUM ADA|LUTFHIAN ALFADHILA SURYANA|PSB|CMI",
		"PTJMahpud0611|rendekidul01|16022545|MAHPUD SOPIAN|PSB|CMI",
		"PTJMARTONO13|INDONESIA#2024|16004766|MARTONO|PSB|CMI",
		"PTJMASKUR13|Maskur130700|16002023|MASKUR|PSB|CLL",
		"PTJrifan07|cimahicity5|Belum Ada|MOCH RIFAN FAKHRIZAL|PSB|CMI",
		"PTJHasan001|Hasan123|BELUM ADA|MUHAMMAD HASAN|PSB|CMI",
		"PTJHasan001|Hasan123|BELUM ADA|MUHAMMAD HASAN|PSB|CMI",
		"PTJImam202002|Ghozali2002|16022546|MUHAMMAD IMAM GHOZALI|PSB|CLL",
		"PTJNRyadi33|Nryadi0303|16995419|NURYADI|PSB|NJG",
		"PTJPurnama07|Purnama76|BELUM ADA|PURNAMA RAMDANI|PSB|CLL",
		"PTJResky022|Telkom2296|16963327|RESKY ARDIANSYAH|PSB|CMI",
		"PTJrmaulana952|bedahciwok001|16953587|RIZWAN MAULANA|PSB|BTJ",
		"PTJSandi014|sandiwah45|BELUM ADA|SANDI WAHYUDI|PSB|BTJ",
		"PTJSanji017|qweasd123|BELUM ADA|SANJI|PSB|CMI",
		"PTJSarijan01|Sarijan12|16901534|SARIJAN|PSB|CLL",
		"PTJSOLIHIN1933|PERSIB1933|16942904|SOLIHIN|PSB|GNH",
		"PTJSyamsul382|BantuFO38|16022056|SYAMSUL BAHRI|PSB|CMI",
		"PTJTubagus13|Tubagus13|16963926|TUBAGUS BUKIYANTORO|PSB|BTJ",
		"PTJUjang9933|Almera0607|Belum ada|UJANG ROHIMAT|PSB|BTJ"
    // contoh tambahan:
    // "vikri|1234|15890001|VIKRI|IOAN|KNG",
    // "wahendra|1234|15890002|WAHENDRA|PIC|CMI"
  ];

  // Konversi ke objek USERS & PEGAWAI (supaya cuma isi di 1 tempat)
  const USERS = USER_LINES.map(line => {
    const [username, password, nik, nama, divisi, area] = line.split("|");
    return { username, password, nik, nama, divisi, defaultArea: area };
  });

  const PEGAWAI = USERS.map(u => ({
    nik: u.nik,
    nama: u.nama,
    divisi: u.divisi
  }));
  /******************************************************/

  let lat = "";
  let lon = "";
  let cameraAvailable = false;
  let currentUser = null;

  const divisiSelect = document.getElementById("divisiSelect");
  const namaSelect   = document.getElementById("namaSelect");
  const nikInput     = document.getElementById("nik");
  const areaInput    = document.getElementById("area");
  const ketSelect    = document.getElementById("ket");
  const video        = document.getElementById("video");
  const canvas       = document.getElementById("canvas");
  const preview      = document.getElementById("preview");
  const lokasi       = document.getElementById("lokasi");
  const statusMsg    = document.getElementById("statusMsg");

  const loginSection = document.getElementById("loginSection");
  const absenSection = document.getElementById("absenSection");
  const loginInfo    = document.getElementById("loginInfo");
  const logoutBtn    = document.getElementById("logoutBtn");
  const loginUserInp = document.getElementById("loginUser");
  const loginPassInp = document.getElementById("loginPass");

  // ===== Filter Nama berdasarkan Divisi =====
  function refreshNamaOptions() {
    const divisi = divisiSelect.value;
    namaSelect.innerHTML = '<option value="">-- Pilih Pegawai --</option>';
    nikInput.value = "";

    if (!divisi) return;

    PEGAWAI.forEach(function(p) {
      if (p.divisi === divisi) {
        const opt = document.createElement("option");
        opt.value = p.nama;
        opt.textContent = p.nama;
        opt.dataset.nik = p.nik;
        namaSelect.appendChild(opt);
      }
    });
  }

  function onNamaChange() {
    const opt = namaSelect.options[namaSelect.selectedIndex];
    nikInput.value = opt && opt.dataset.nik ? opt.dataset.nik : "";
  }

  divisiSelect.addEventListener("change", refreshNamaOptions);
  namaSelect.addEventListener("change", onNamaChange);

  // ===== LOGIN / LOGOUT =====
  function handleLogin() {
    const u = loginUserInp.value.trim();
    const p = loginPassInp.value.trim();

    if (!u || !p) {
      alert("User ID dan Password wajib diisi.");
      return;
    }

    let found = null;

    USERS.forEach(acc => {
      if (
        acc.username.toLowerCase() === u.toLowerCase() &&
        acc.password === p
      ) {
        found = acc;
      }
    });

    if (!found) {
      alert("User ID atau Password salah.");
      return;
    }

    currentUser = found;

    // set divisi & nama sesuai user
    divisiSelect.value = currentUser.divisi;
    refreshNamaOptions();

    for (let i = 0; i < namaSelect.options.length; i++) {
      if (namaSelect.options[i].value === currentUser.nama) {
        namaSelect.selectedIndex = i;
        break;
      }
    }
    onNamaChange();

    // set area default (boleh diganti)
    if (currentUser.defaultArea) {
      areaInput.value = currentUser.defaultArea;
    }

    loginInfo.style.display = "block";
    loginInfo.textContent =
      "Login sebagai: " + currentUser.nama + " (" + currentUser.divisi + ")";

    loginSection.style.display = "none";
    absenSection.style.display = "block";
    logoutBtn.style.display = "block";

    statusMsg.textContent = "";
    preview.style.display = "none";
    canvas.width = canvas.height = 0;
  }

  function handleLogout() {
    currentUser = null;
    loginUserInp.value = "";
    loginPassInp.value = "";

    divisiSelect.value = "";
    refreshNamaOptions();
    areaInput.value = "";
    ketSelect.value = "masuk";
    updateKetClass();
    preview.style.display = "none";
    canvas.width = canvas.height = 0;
    statusMsg.textContent = "";

    loginSection.style.display = "block";
    absenSection.style.display = "none";
    logoutBtn.style.display = "none";
    loginInfo.style.display = "none";
  }

  // ===== Warna dropdown Keterangan =====
  function updateKetClass() {
    ketSelect.classList.remove("status-masuk","status-libur","status-cuti","status-sakit");
    if (ketSelect.value === "masuk") ketSelect.classList.add("status-masuk");
    else if (ketSelect.value === "libur") ketSelect.classList.add("status-libur");
    else if (ketSelect.value === "cuti") ketSelect.classList.add("status-cuti");
    else if (ketSelect.value === "sakit") ketSelect.classList.add("status-sakit");
  }
  ketSelect.addEventListener("change", updateKetClass);
  updateKetClass(); // awal

  // ===== Kamera =====
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video:true })
      .then(function(stream) {
        cameraAvailable = true;
        video.srcObject = stream;
      })
      .catch(function(err) {
        cameraAvailable = false;
        statusMsg.textContent = "Gagal akses kamera: " + err.message;
      });
  } else {
    statusMsg.textContent = "Browser tidak mendukung kamera.";
  }

  function ambilFoto() {
    if (!currentUser) {
      alert("Silakan login terlebih dahulu.");
      return;
    }
    if (!cameraAvailable || !video.videoWidth || !video.videoHeight) {
      alert("Kamera tidak aktif / ditolak.");
      return;
    }
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL("image/jpeg");
    preview.src = dataUrl;
    preview.style.display = "block";
    alert("Foto berhasil diambil!");
  }

  // ===== Lokasi =====
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      function(pos) {
        lat = pos.coords.latitude;
        lon = pos.coords.longitude;
        lokasi.textContent = "Lat: " + lat.toFixed(6) + ", Lon: " + lon.toFixed(6);
      },
      function(err) {
        lokasi.textContent = "Lokasi gagal: " + err.message;
      }
    );
  } else {
    lokasi.textContent = "Browser tidak mendukung lokasi.";
  }

  function resetFormAfterSend() {
    areaInput.value = currentUser && currentUser.defaultArea ? currentUser.defaultArea : "";
    ketSelect.value = "masuk";
    updateKetClass();
    preview.style.display = "none";
    canvas.width = 0;
    canvas.height = 0;
    statusMsg.textContent = "";
  }

  // ===== Kirim Absensi =====
  function kirimAbsensi(mode) {
    if (!currentUser) {
      alert("Silakan login terlebih dahulu.");
      return;
    }

    const divisi = divisiSelect.value.trim();
    const nama   = namaSelect.value.trim();
    const nik    = nikInput.value.trim();
    const area   = areaInput.value.trim();
    const ket    = ketSelect.value;

    if (!divisi || !nama || !nik || !area) {
      alert("Divisi, Nama, NIK, dan Area Kerja wajib diisi.");
      return;
    }

    let fotoBase64 = "";
    if (canvas.width && canvas.height) {
      fotoBase64 = canvas.toDataURL("image/jpeg").split(",")[1];
    } else {
      const lanjut = confirm("Belum ada foto. Lanjut absen tanpa foto?");
      if (!lanjut) return;
    }

    statusMsg.textContent = "Mengirim absensi...";

    fetch("https://script.google.com/macros/s/AKfycbxomZTLRZZ69y-2iKIieCqCf8jbTfGpu5BhSFOecq3pdkSRqgw8Aei6Ja9c0EPX_e9f/exec", {   // <<< GANTI DENGAN URL WEB APP (/exec)
      method: "POST",
      body: JSON.stringify({
        mode : mode,
        nik  : nik,
        nama : nama,
        area : area,
        divisi: divisi,
        ket  : ket,
        photo: fotoBase64,
        lat  : lat,
        lon  : lon
      })
    })
    .then(function(res) { return res.text(); })
    .then(function(text) {
      statusMsg.textContent = "Respon server: " + text;
      if (text.indexOf("ERROR") === 0) {
        alert(text);  // pesan dari server (termasuk "Nama ini sudah absen hari ini")
      } else {
        alert("Absensi " + mode + " terkirim!");
        resetFormAfterSend();
      }
    })
    .catch(function(err) {
      statusMsg.textContent = "Gagal kirim: " + err.message;
      alert("Terjadi error saat mengirim absensi.");
    });
  }

  window.ambilFoto     = ambilFoto;
  window.kirimAbsensi  = kirimAbsensi;
  window.handleLogin   = handleLogin;
  window.handleLogout  = handleLogout;
</script>
</body>
</html>






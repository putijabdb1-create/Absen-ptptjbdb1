<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Pegawai - PT PUTRA TIMUR JAYA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #00141f, #003c5c, #00897b);
      background-size: 300% 300%;
      animation: gradientMove 16s ease infinite;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 100%; }
      100% { background-position: 0% 0%; }
    }

    .wrapper { width: 100%; max-width: 460px; }

    .brand-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      color: #e0fdf2;
      text-shadow: 0 0 8px rgba(0,0,0,0.4);
    }
    .brand-logo {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      object-fit: cover;
      background: #e0fdf2;
      box-shadow: 0 0 16px rgba(0,255,200,0.65);
    }
    .brand-name {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 13px;
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(18px);
      width: 100%;
      border-radius: 22px;
      padding: 22px 18px 18px;
      box-shadow:
        0 25px 40px rgba(0, 0, 0, 0.35),
        0 0 20px rgba(0, 255, 200, 0.3);
      border: 1px solid rgba(255,255,255,0.55);
    }

    h2 {
      text-align: center;
      color: #0f172a;
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 16px;
    }

    label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #374151;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      margin-bottom: 10px;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    input:focus, select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb33;
      background: #ffffff;
    }
    input[readonly] { background: #f3f4f6; }

    /* WARNA KETERANGAN */
    #ket { transition: background 0.2s, color 0.2s, border-color 0.2s; color:#111827; }
    .status-masuk { background:#dcfce7!important; border-color:#16a34a!important; color:#14532d!important; }
    .status-libur { background:#fee2e2!important; border-color:#dc2626!important; color:#7f1d1d!important; }
    .status-cuti  { background:#dbeafe!important; border-color:#2563eb!important; color:#1e3a8a!important; }
    .status-sakit { background:#fef3c7!important; border-color:#f59e0b!important; color:#92400e!important; }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 10px;
      margin-top: -4px;
    }
    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border-width: 1px;
      border-style: solid;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .b-masuk { background:#dcfce7; border-color:#16a34a; color:#14532d; }
    .b-libur { background:#fee2e2; border-color:#dc2626; color:#7f1d1d; }
    .b-cuti  { background:#dbeafe; border-color:#2563eb; color:#1e3a8a; }
    .b-sakit { background:#fef3c7; border-color:#f59e0b; color:#92400e; }

    video, canvas, img {
      width: 100%;
      border-radius: 12px;
    }
    video {
      background: #020617;
      max-height: 220px;
      object-fit: cover;
    }

    .btn {
      width: 100%;
      padding: 11px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
      letter-spacing: 0.01em;
    }
    .btn-camera { background:#020617; color:white; }
    .btn-masuk  { background:#2563eb; color:white; }
    .btn-pulang { background:#10b981; color:white; }
    .btn-login  { background:#0ea5e9; color:white; }
    .btn-logout { background:#ef4444; color:white; }
    .btn:hover  { filter: brightness(1.05); }

    .small { font-size: 12px; color: #6b7280; }
    #statusMsg { margin-top: 8px; min-height: 16px; }

    #loginInfo {
      font-size: 12px;
      color: #065f46;
      font-weight: 600;
      margin-bottom: 6px;
      display:none;
    }
    #logoutBtn { display:none; }

    hr { border:none; border-top:1px dashed #e5e7eb; margin:10px 0 14px; }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- HEADER BRAND -->
    <div class="brand-bar">
      <img src="logo-pttj.png" alt="Logo PT PUTRA TIMUR JAYA" class="brand-logo">
      <span class="brand-name">PT PUTRA TIMUR JAYA</span>
    </div>

    <div class="card">
      <h2>Absensi Pegawai</h2>

      <!-- LOGIN -->
      <div id="loginSection">
        <label>Login Teknisi</label>
        <input id="loginUser" placeholder="User ID">
        <input id="loginPass" type="password" placeholder="Password">
        <button class="btn btn-login" type="button" onclick="handleLogin()">üîë Login</button>
        <div class="small" style="margin-top:6px;">
          Hanya teknisi terdaftar yang dapat mengakses absensi.
        </div>
        <hr>
      </div>

      <div id="loginInfo"></div>
      <button id="logoutBtn" class="btn btn-logout" type="button" onclick="handleLogout()">üö™ Logout</button>

      <!-- FORM ABSENSI -->
      <div id="absenSection" style="display:none; margin-top:10px;">

        <label>Divisi</label>
        <select id="divisiSelect" disabled>
          <option value="">-- Pilih Divisi --</option>
          <option value="IOAN">IOAN</option>
          <option value="PSB">PSB</option>
          <option value="PROJEK">PROJEK</option>
          <option value="PIC">PIC</option>
        </select>

        <label>Nama</label>
        <select id="namaSelect" disabled>
          <option value="">-- Pilih Pegawai --</option>
        </select>

        <label>NIK</label>
        <input id="nik" placeholder="NIK otomatis" readonly>

        <label>Area Kerja</label>
        <select id="area">
          <option value="">-- Pilih Area Kerja --</option>
          <option value="CMI">CMI</option>
          <option value="NJG">NJG</option>
          <option value="CLL">CLL</option>
          <option value="BTJ">BTJ</option>
          <option value="GNH">GNH</option>
          <option value="KNG">KNG</option>
        </select>

        <label>Keterangan</label>
        <select id="ket">
          <option value="masuk">Masuk</option>
          <option value="libur">Libur</option>
          <option value="cuti">Cuti</option>
          <option value="sakit">Sakit</option>
        </select>

        <div class="legend">
          <span class="badge b-masuk">Masuk = Hijau</span>
          <span class="badge b-libur">Libur = Merah</span>
          <span class="badge b-cuti">Cuti = Biru</span>
          <span class="badge b-sakit">Sakit = Kuning</span>
        </div>

        <!-- KETERANGAN TAMBAHAN -->
        <label for="note">Keterangan tambahan</label>
        <textarea id="note" rows="2" style="
          width:100%;
          padding:8px 10px;
          border-radius:10px;
          border:1px solid #d1d5db;
          font-size:13px;
          resize:vertical;
          margin-bottom:10px;
        " placeholder="Contoh: batuk ringan, kurang sehat, ada urusan keluarga, dll."></textarea>

        <label>Foto Absensi</label>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="preview" style="display:none; margin-top:5px;">

        <button class="btn btn-camera" type="button" onclick="ambilFoto()">üì∏ Ambil Foto</button>

        <label>Lokasi GPS</label>
        <div id="lokasi" class="small">Mengambil lokasi...</div>

        <button class="btn btn-masuk"  type="button" onclick="kirimAbsensi('masuk')">‚úÖ Absen Masuk</button>
        <button class="btn btn-pulang" type="button" onclick="kirimAbsensi('pulang')">üèÅ Absen Pulang</button>

        <div id="statusMsg" class="small"></div>
      </div>
    </div>
  </div>

<script>
  /********* LOGIN USER SIMPLE *********/
  // Format 1 baris user:
  // "username|password|nik|nama|divisi|defaultArea"
  const USER_LINES = [
    "PTJ_Arip007|alvaro007|15889311|ARIP RAHMATULLOH|PIC|CMI",
    "PTJ_U_Setiadi|30223023|15889310|UUS SETIADI|PIC|BTJ",
    "PTJ_Bob1990|TE1990|BELUM ADA|ASEP SAEPUDIN|PIC|CMI",
	"PTJ_Du2ng|Aisha221011|BELUM ADA|DUDUNG SUKMANA|PIC|CMI",
  	"PTJ_Endi1994|Ardila06@@|15889307|ENDI HENDRIANA|PIC|CMI",
	"PTJ_FirmanFirdaus013|FirmanFirdaus013|16990042|MUHAMMAD FIRMAN DAUD FIRDAUS|PIC|CMI",
	"PTJ_Vikri012|Vikri0012|BELUM ADA|VIKRI FADHI RAHMAN|PIC|BTJ",
	"PTJ_Agus25|Ajiz1989|16891202|AGUS|IOAN|NJG",
	"PTJ_Alfian07|Fianape7|16004674|ALFIAN PERMADI HERDIANSYAH|IOAN|CMI",
	"PTJ_Anggi13|Zhafran02|15892036|ANGGI SETIAWAN|IOAN|BTJ",
	"PTJ_Asep125|4sep5ule|15889318|ASEP SULAEMAN|IOAN|NJG",
	"PTJ_Asep006|Bacilu01|15889328|ASEP SUTARYAT|IOAN|BTJ",
	"PTJ_Mardian67|Mardian67|16012066|DANDI MARDIANSYAH|IOAN|GNH",
	"PTJ_Deni017|Denok017|16050949|DENI EGI SAPUTRA|IOAN|CMI",
	"PTJ_Deni699|Deni@699|16850259|DENI WARDANI|IOAN|BTJ",
	"PTJ_Deniec15889321|Nanjung2025|15889321|DENIEC GORO SULISTYANTO|IOAN|NJG",
	"PTJ_DODIMARDANI004|Putija004|15889324|DODI MARDANI|IOAN|CLL",
	"PTJ_Engkos270|Kostaman80|15889334|ENGKOS KOSTAMAN|IOAN|NJG",
	"PTJ_Fakhri95|Fakhr1995|15889339|FAKHRI RASYAD RAMDHANI|IOAN|CMI",
	"PTJ_Giant77|Telkom77|15889330|GIAN KRISTAL|IOAN|NJG",
	"PTJ_INDRA999|270310Aa|16921681|INDRA PRATAMA|IOAN|NJG",
	"PTJ_Nugraha24|Street24|15882130|INSAN NUGRAHA|IOAN|CMI",
	"PTJ_Irfanm019|putija@1|16950710|IRFAN MAULANA|IOAN|CMI",
	"PTJ_Irfan16022301|Bacilu01|16022301|IRFAN NURJAMAN|IOAN|BTJ",
	"PTJ_Juli86|juli0786|15889309|JULI SURYANA|IOAN|NJG",
  	"PTJ_Nazli313|arkan2015|15889313|NAZLI RUDI YANTO|IOAN|CMI",
	"PTJ_Rendyherwansyah|putija@2025|15902465|RENDI HERWANSYAH|IOAN|GNH",
	"PTJ_Galing28|galing2810|15901086|RIDWAN RISWANDI|IOAN|NJG",
	"PTJ_Sahibul87|ahyad87|15889319|SAHIBUL AHYAD|IOAN|CMI",
	"PTJ_Taryana2004|atar2004|15889316|TARYANA|IOAN|CMI",
	"PTJ_TAUFIK046|PUTIJA046|15889345|TAUFIK HIDAYAT|IOAN|NJG",
	"PTJ_Tisna05|241103rm|15889326|TISNA|IOAN|BTJ",
	"PTJ_Ujang77|uchin2877|15889333|UJANG MUKSIN|IOAN|CMI",
	"PTJ_Yogi28|Yogi2828|16950715|YOGI TJANDRA FERNANDO|IOAN|CMI",
	"PTJ_YUNUS696|Absen696|15900696|YUNUS HITOTUN|IOAN|CMI",
    "PTJ_Aditya129|aditya0707|BELUM ADA|ADITYA RAMDAN SYARIF|PSB|BTJ",
    "PTJ_Yusup16942254|putija@2028|16942254|AHMAD MAULANA YUSUP|PSB|BTJ",
    "PTJ_Ahmad29040|zaki290406|BELUM ADA|AHMAD ZAQI|PSB|CMI",
    "PTJ_Andi027|mspeed27|16952753|ANDI RAMDANI|PSB|CMI",
    "PTJ_ANDIAN666|123Asik#|BELUM ADA|ANDIAN WAHYUDI|PSB|CLL",
    "PTJ_Ardian17|deci12345|BELUM ADA|ARDIAN HAFIDZ|PSB|BTJ",
    "PTJ_Arga003|Arga1603|16901188|ARGA ALI SANTIAJI|PSB|NJG",
    "PTJ_Aria015|Aria2025|16911316|ARIA RIDWANTO|PSB|CLL",
    "PTJ_Asep0797|Telkom0797|16974185|ASEP SAEPUL HIDAYAT|PSB|GNH",
    "PTJ_Dedi08|RizkiRizam12|16820493|DEDI WINARDI|PSB|NJG",
    "PTJ_Enjang93|Hardi1993|16931851|ENJANG HARDI|PSB|CMI",
    "PTJ_Febby90|putija25|16901210|FEBBY REZA NURHUDA|PSB|CLL",
    "PTJ_IbnuDcs|Kududiuye|16022542|IBNU DZAHABI|PSB|CMI",
    "PTJ_Bowo182|makemanah85|16850029|KHOERUDIN PRABOWO|PSB|CMI",
    "PTJ_Ilyas1289|Rilkay2018|15891521|KM ILYAS AKBAR|PSB|NJG",
    "PTJ_PadiiiL7|padilada22|BELUM ADA|LUTFHIAN ALFADHILA SURYANA|PSB|CMI",
    "PTJ_Mahpud0611|rendekidul01|16022545|MAHPUD SOPIAN|PSB|CMI",
    "PTJ_MARTONO13|INDONESIA#2024|16004766|MARTONO|PSB|CMI",
    "PTJ_MASKUR13|Maskur130700|16002023|MASKUR|PSB|CLL",
    "PTJ_rifan07|cimahicity5|Belum Ada|MOCH RIFAN FAKHRIZAL|PSB|CMI",
    "PTJ_Hasan001|Hasan123|BELUM ADA|MUHAMMAD HASAN|PSB|CMI",
    "PTJ_Imam202002|Ghozali2002|16022546|MUHAMMAD IMAM GHOZALI|PSB|CLL",
    "PTJ_NRyadi33|Nryadi0303|16995419|NURYADI|PSB|NJG",
    "PTJ_Purnama07|Purnama76|BELUM ADA|PURNAMA RAMDANI|PSB|CLL",
    "PTJ_Resky022|Telkom2296|16963327|RESKY ARDIANSYAH|PSB|CMI",
    "PTJ_rmaulana952|bedahciwok001|16953587|RIZWAN MAULANA|PSB|BTJ",
    "PTJ_Sandi014|sandiwah45|BELUM ADA|SANDI WAHYUDI|PSB|BTJ",
    "PTJ_Sanji017|qweasd123|BELUM ADA|SANJI|PSB|CMI",
    "PTJ_Sarijan01|Sarijan12|16901534|SARIJAN|PSB|CLL",
    "PTJ_SOLIHIN1933|PERSIB1933|16942904|SOLIHIN|PSB|GNH",
    "PTJ_Syamsul382|BantuFO38|16022056|SYAMSUL BAHRI|PSB|CMI",
    "PTJ_Tubagus13|Tubagus13|16963926|TUBAGUS BUKIYANTORO|PSB|BTJ",
    "PTJ_Ujang9933|Almera0607|Belum ada|UJANG ROHIMAT|PSB|BTJ",
	"PTJ_BILAL23|bilal1234|16994703|BILAL FISSABILILLAH|PSB|BTJ",
	"PTJ_Robi1121|slipknot.1960|BELUM ADA|AZIS ROBIANSYAH|PSB|CLL",
	"PTJ_@PilihanHelaWeh|16870758|16870758|UJANG SUMPENA|PSB|CMI",
	"PTJ_Zacky123|Kadungora05|BELUM ADA|MOCH ZACKY AZKARI|PSB|BTJ",
	"PTJ_Ryanfir72|ryanfi72|BELUM ADA|RIYAN FIRMANSAH|PSB|CMI",
	"PTJ_Alva30|Sunang30|16991540|MUHAMMAD ALVA RIZKY|IOAN|CMI",
	"PTJ_Dikiw15|Dikiw12345|BELUM ADA|DIKI WAHYUDI SETIAWAN|PSB|CLL",
	"PTJ_Hermawan19|persija19|BELUM ADA|HERMAWAN|PSB|CLL",
	"PTJ_rasyid2007|satusampai9|BELUM ADA|ABDUL RASYID AHMADI RAZZAQ|PSB|NJG",
	"PTJ_Hendra303|PTJ_Hendra303|15889332|HENDRA PERMANA|IOAN|NJG",
	"PTJ_Heri2025|cimahi2025|16770224|HERI NURDIANA SANTOSA|PSB|NJG",
	"PTJ_WAHENDRA|Project01|BELUM ADA|WAHENDRA|PIC|CMI",
	"PTJ_ADI SOPIAN|Project01|BELUM ADA|ADI SOPIAN|PIC|CMI",
	"PTJ_Dicky029|Dicky029|16974122|DICKY IRAWAN SONJAYA|PSB|CMI",
	"PTJ_GAGAN SUHERMAN|Project01|BELUM ADA|GAGAN SUHERMAN|PROJEK|CMI",
	"PTJ_DEDE YUSUP|Project01|BELUM ADA|DEDE YUSUP|PROJEK|BTJ",
	"PTJ_RAIHAN|Project01|BELUM ADA|MOCHAMAD RAIHAN ARYA AGUNG|PROJEK|BTJ",
	"PTJ_RESTU|Project01|BELUM ADA|RESTU|PROJEK|CMI",
	"PTJ_RIFKI|Project01|BELUM ADA|RIFKI|PROJEK|CMI",
	"PTJ_Ambar71R|Rawing71|15889320|AMBARYADI GUNAWAN|PSB|NJG",
	"PTJ_AGUNGINDRA014|agungindra041498|16982268|AGUNG INDRA LESMANA|PSB|BTJ",
	"PTJ_bilalfajri27|bilalfajri2005|belum ada|MUHAMAD BILAL FAJRI|PSB|CMI",
	"PTJ_Pentingberkah|Ganjar83|15889317|GANJAR SAEPUDIN|IOAN|CMI",
	"PTJ_ADE22|layadmos2312|16002299|ADE SOPIYAN|IOAN|KNG",
	"PTJ_Nana007|tamanana6661|16022091|NANA ADITAMA|IOAN|KNG",
	"PTJ_Zul78|Aqi11aram|16780156|ZULHAM EFFENDI ZAS|PSB|NJG",
	"PTJ_Opi012|Toren1234|16942370|OPIK IRAWAN|IOAN|KNG",
	"PTJ_Refli012|Putija@12|16023016|REFLI PITDATULLOH|PSB|CMI",
	"PTJ_Puad98|Telkom123|16983641|PUAD TOHAWI|PSB|CLL",
	"PTJ_Dendi@01|1052002|(Belum Ada)|DENDI MANDIRI|PSB|BTJ"
    // tambahkan user lain di sini...
  ];

  // mapping USER_LINES -> USERS & PEGAWAI
  const USERS = USER_LINES.map(line => {
    const [username, password, nik, nama, divisi, area] = line.split("|");
    return { username, password, nik, nama, divisi, defaultArea: area };
  });
  const PEGAWAI = USERS.map(u => ({
    nik: u.nik,
    nama: u.nama,
    divisi: u.divisi
  }));

  // ==== VARIABEL DOM & STATE ====
  let lat = "";
  let lon = "";
  let cameraAvailable = false;
  let currentUser = null;

  const divisiSelect = document.getElementById("divisiSelect");
  const namaSelect   = document.getElementById("namaSelect");
  const nikInput     = document.getElementById("nik");
  const areaInput    = document.getElementById("area");
  const ketSelect    = document.getElementById("ket");
  const video        = document.getElementById("video");
  const canvas       = document.getElementById("canvas");
  const preview      = document.getElementById("preview");
  const lokasi       = document.getElementById("lokasi");
  const statusMsg    = document.getElementById("statusMsg");
  const noteInput    = document.getElementById("note");

  const loginSection = document.getElementById("loginSection");
  const absenSection = document.getElementById("absenSection");
  const loginInfo    = document.getElementById("loginInfo");
  const logoutBtn    = document.getElementById("logoutBtn");
  const loginUserInp = document.getElementById("loginUser");
  const loginPassInp = document.getElementById("loginPass");

  // ===== Filter Nama berdasarkan Divisi =====
  function refreshNamaOptions() {
    const divisi = divisiSelect.value;
    namaSelect.innerHTML = '<option value="">-- Pilih Pegawai --</option>';
    nikInput.value = "";

    if (!divisi) return;

    PEGAWAI.forEach(p => {
      if (p.divisi === divisi) {
        const opt = document.createElement("option");
        opt.value = p.nama;
        opt.textContent = p.nama;
        opt.dataset.nik = p.nik;
        namaSelect.appendChild(opt);
      }
    });
  }
  function onNamaChange() {
    const opt = namaSelect.options[namaSelect.selectedIndex];
    nikInput.value = opt && opt.dataset.nik ? opt.dataset.nik : "";
  }
  divisiSelect.addEventListener("change", refreshNamaOptions);
  namaSelect.addEventListener("change", onNamaChange);

  // ===== LOGIN / LOGOUT =====
  function handleLogin() {
    const u = loginUserInp.value.trim();
    const p = loginPassInp.value.trim();
    if (!u || !p) {
      alert("User ID dan Password wajib diisi.");
      return;
    }

    let found = null;
    USERS.forEach(acc => {
      if (acc.username.toLowerCase() === u.toLowerCase() && acc.password === p) {
        found = acc;
      }
    });

    if (!found) {
      alert("User ID atau Password salah.");
      return;
    }

    currentUser = found;

    // set divisi & nama sesuai user
    divisiSelect.value = currentUser.divisi;
    refreshNamaOptions();
    for (let i = 0; i < namaSelect.options.length; i++) {
      if (namaSelect.options[i].value === currentUser.nama) {
        namaSelect.selectedIndex = i;
        break;
      }
    }
    onNamaChange();

    // set area default
    if (currentUser.defaultArea) {
      areaInput.value = currentUser.defaultArea;
    }

    loginInfo.style.display = "block";
    loginInfo.textContent = "Login sebagai: " + currentUser.nama + " (" + currentUser.divisi + ")";
    loginSection.style.display = "none";
    absenSection.style.display = "block";
    logoutBtn.style.display = "block";

    statusMsg.textContent = "";
    preview.style.display = "none";
    canvas.width = canvas.height = 0;
  }

  function handleLogout() {
    currentUser = null;
    loginUserInp.value = "";
    loginPassInp.value = "";

    divisiSelect.value = "";
    refreshNamaOptions();
    areaInput.value = "";
    ketSelect.value = "masuk";
    updateKetClass();
    noteInput.value = "";
    preview.style.display = "none";
    canvas.width = canvas.height = 0;
    statusMsg.textContent = "";

    loginSection.style.display = "block";
    absenSection.style.display = "none";
    logoutBtn.style.display = "none";
    loginInfo.style.display = "none";
  }

  // ===== Warna dropdown Keterangan =====
  function updateKetClass() {
    ketSelect.classList.remove("status-masuk","status-libur","status-cuti","status-sakit");
    if (ketSelect.value === "masuk") ketSelect.classList.add("status-masuk");
    else if (ketSelect.value === "libur") ketSelect.classList.add("status-libur");
    else if (ketSelect.value === "cuti")  ketSelect.classList.add("status-cuti");
    else if (ketSelect.value === "sakit") ketSelect.classList.add("status-sakit");
  }
  ketSelect.addEventListener("change", updateKetClass);
  updateKetClass();

  // ===== Kamera =====
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video:true })
      .then(stream => {
        cameraAvailable = true;
        video.srcObject = stream;
      })
      .catch(err => {
        cameraAvailable = false;
        statusMsg.textContent = "Gagal akses kamera: " + err.message;
      });
  } else {
    statusMsg.textContent = "Browser tidak mendukung kamera.";
  }

  function ambilFoto() {
    if (!currentUser) {
      alert("Silakan login terlebih dahulu.");
      return;
    }
    if (!cameraAvailable || !video.videoWidth || !video.videoHeight) {
      alert("Kamera tidak aktif / ditolak.");
      return;
    }
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    const dataUrl = canvas.toDataURL("image/jpeg");
    preview.src = dataUrl;
    preview.style.display = "block";
    alert("Foto berhasil diambil!");
  }

  // ===== Lokasi =====
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        lat = pos.coords.latitude;
        lon = pos.coords.longitude;
        lokasi.textContent = "Lat: " + lat.toFixed(6) + ", Lon: " + lon.toFixed(6);
      },
      err => {
        lokasi.textContent = "Lokasi gagal: " + err.message;
      }
    );
  } else {
    lokasi.textContent = "Browser tidak mendukung lokasi.";
  }

  function resetFormAfterSend() {
    areaInput.value = currentUser && currentUser.defaultArea ? currentUser.defaultArea : "";
    ketSelect.value = "masuk";
    updateKetClass();
    noteInput.value = "";
    preview.style.display = "none";
    canvas.width = 0;
    canvas.height = 0;
    statusMsg.textContent = "";
  }

  // ===== Kirim Absensi =====
  const FETCH_URL_WEB_APP = "https://script.google.com/macros/s/AKfycbxomZTLRZZ69y-2iKIieCqCf8jbTfGpu5BhSFOecq3pdkSRqgw8Aei6Ja9c0EPX_e9f/exec"; // <<< GANTI dengan URL Web App Apps Script (akhiran /exec)

  function kirimAbsensi(mode) {
    if (!currentUser) {
      alert("Silakan login terlebih dahulu.");
      return;
    }

    const divisi = divisiSelect.value.trim();
    const nama   = namaSelect.value.trim();
    const nik    = nikInput.value.trim();
    const area   = areaInput.value.trim();
    const ket    = ketSelect.value;
    const note   = noteInput.value.trim();

    if (!divisi || !nama || !nik || !area) {
      alert("Divisi, Nama, NIK, dan Area Kerja wajib diisi.");
      return;
    }

    let fotoBase64 = "";
    if (canvas.width && canvas.height) {
      fotoBase64 = canvas.toDataURL("image/jpeg").split(",")[1];
    } else {
      const lanjut = confirm("Belum ada foto. Lanjut absen tanpa foto?");
      if (!lanjut) return;
    }

    statusMsg.textContent = "Mengirim absensi...";

    fetch(FETCH_URL_WEB_APP, {
      method: "POST",
      body: JSON.stringify({
        mode : mode,
        nik  : nik,
        nama : nama,
        area : area,
        divisi: divisi,
        ket  : ket,
        note : note,
        photo: fotoBase64,
        lat  : lat,
        lon  : lon
      })
    })
    .then(res => res.text())
    .then(text => {
      statusMsg.textContent = "Respon server: " + text;
      if (text.indexOf("ERROR") === 0) {
        alert(text);
      } else {
        alert("Absensi " + mode + " terkirim!");
        resetFormAfterSend();
      }
    })
    .catch(err => {
      statusMsg.textContent = "Gagal kirim: " + err.message;
      alert("Terjadi error saat mengirim absensi.");
    });
  }

  // expose ke onclick HTML
  window.handleLogin  = handleLogin;
  window.handleLogout = handleLogout;
  window.ambilFoto    = ambilFoto;
  window.kirimAbsensi = kirimAbsensi;
</script>
</body>
</html>
